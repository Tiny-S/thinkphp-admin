(function() {
    tinymce.create('tinymce.plugins.ImageManagerPlugin', {
        init : function(ed, url) {
            url = tinyMCE.activeEditor.getParam('imagemanager_rel') || url;
            var imagemanager_url = tinyMCE.activeEditor.getParam('imagemanager_url');

            var head = document.getElementsByTagName('body')[0];
            var css = document.createElement('link');
            css.type = 'text/css';
            css.rel = 'stylesheet';
            css.href = url + '/css/style.css';
            head.appendChild(css);

            // Register commands
            ed.addCommand('mceImageManager', function() {

                // 下面加载视图
                var html = '<div class="tinymce-imagemanager-main"><div class="tinymce-imagemanager-title">图片管理</div><div class="tinymce-imagemanager-content" id="tinymce-imagemanager-content"></div><div class="tinymce-imagemanager-button" id="tinymce-imagemanager-button"><button type="button" class="btn btn-green">确定</button></div></div>';
                $.Dialog.open('tinymce-imagemanager',false,html);
                $.Page.ajaxGet(imagemanager_url,'#content','#tinymce-imagemanager-content',false,function(){
                    // 允许上传
                    $('#picture_manager_upload').HHuploadify({
                        auto: true,
                        fileTypeExts: '*.jpg;*.png;*.jpeg;*.gif',
                        multi: true,
                        buttonText: '上传图片',
                        fileSizeLimit: 99999999,
                        uploader: uploader,
                        onUploadSuccess:function(file,result){
                            var instanceNumber = $('#picture_manager_upload').find('.uploadify').index('.uploadify') + 1;
                            var $item = $('#fileupload_'+instanceNumber+'_'+file.index);
                            $item.addClass('selected');
                            $item.find('.delfilebtn').remove();
                        }
                    });
                    // 翻页
                    $('#tinymce-imagemanager .dialog-container').scroll(function(){
                        var $this = $(this);
                        var scrollTop = $this.scrollTop(),
                            height = $this.height(),
                            next = $this.find('#pagenavi .current').next().attr('href');
                        if(next == undefined) {
                            $this.find('#pagenavi').remove();
                            return;
                        }
                        if(height - scrollTop  < 500) {
                            if($this.attr('data-paging') == 1)
                                return;
                            $this.attr('data-paging',1);
                            $.get(next,function(result){
                                var $html = $('<div>' + result + '</div>');
                                var content = $html.find('#content .uploadify-queue-item');
                                var pagenavi = $html.find('#pagenavi').html();
                                $this.find('#picture_manager_upload').before(content);
                                $this.find('#pagenavi').html(pagenavi);
                                next = $this.find('#pagenavi .current').next().attr('href');
                                if(next == undefined)
                                    $this.find('#pagenavi').remove();
                                $this.removeAttr('data-paging');
                            });
                        }
                    }).scroll();
                });

                // 下面写逻辑代码
                $(document).on('click','#tinymce-imagemanager-content .uploadify-queue-item',function(){
                    var $this = $(this);
                    if($this.attr('data-clicking') == 1)
                        return;
                    $this.attr('data-clicking',1);
                    $this.toggleClass('selected');
                    setTimeout(function(){
                        $this.removeAttr('data-clicking');
                    },100);
                });

                // 插入到编辑器
                $(document).on('click','#tinymce-imagemanager-button button',function(){
                    var $items = $('#tinymce-imagemanager-content .uploadify-queue-item.selected');
                    var images = '';
                    $items.each(function(index){
                        var url = $(this).css('background-image');
                        url = url.slice(5,-2);
                        images += '<img src="%s" style="max-width: 90%;">'.replace('%s',url);
                    });
                    ed.insertContent(images);
                    ed.focus();
                    $.Dialog.close('tinymce-imagemanager');
                    $.Dialog.remove('tinymce-imagemanager');
                });

                // end
            });

            // Register buttons
            ed.addButton('imagemanager', {
                title : 'Image Manager',
                cmd : 'mceImageManager',
                image : url + '/img/icon.png'
            });
        },

        getInfo : function() {
            return {
                longname : 'Image Manager',
                author : 'Tison',
                authorurl : 'https://github.com/tangshuang',
                infourl : 'https://github.com/tangshuang/tinymce-imagemanager',
                version : '0.1.0'
            };
        }
    });

    tinymce.PluginManager.add('imagemanager', tinymce.plugins.ImageManagerPlugin);
})();